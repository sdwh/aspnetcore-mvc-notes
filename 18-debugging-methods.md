# ASP.NET Core MVC 教學 (.NET 8)：正確的偵錯方法

偵錯 (Debugging) 是軟體開發過程中不可或缺的一環。它不僅僅是找到並修復錯誤，更是一個深入理解程式碼執行流程、驗證邏輯假設的過程。在 ASP.NET Core MVC 中，利用現代 IDE (如 Visual Studio, VS Code) 提供的強大偵錯工具，可以極大地提升開發效率和程式碼品質。

本文將介紹在 ASP.NET Core 開發中最常用且最高效的偵錯方法。

## 1. 中斷點 (Breakpoints)

中斷點是你偵錯工具箱中最基本的工具。它允許你在程式碼的特定行暫停執行，以便檢查當前的狀態。

### a. 設定與使用
在 Visual Studio 或 VS Code 中，只需在程式碼編輯器的左側邊欄點擊一下，即可設定一個中斷點（通常顯示為一個紅點）。當應用程式以偵錯模式執行到這一行時，執行會暫停。

**偵錯時的常用操作：**
*   **逐程序 (Step Over, F10)**: 執行目前行，並移動到下一行。如果目前行是一個方法呼叫，它會執行完整個方法，而**不會**進入該方法內部。
*   **逐陳述式 (Step Into, F11)**: 執行目前行。如果目前行是一個方法呼叫，偵錯器將會**進入**該方法的內部，讓你逐行偵錯該方法。
*   **跳離 (Step Out, Shift+F11)**: 如果你已經在一個方法內部，這個操作會執行完該方法的剩餘部分，並回到呼叫它的那一行。
*   **繼續 (Continue, F5)**: 繼續執行程式，直到遇到下一個中斷點或程式結束。

### b. 條件中斷點 (Conditional Breakpoints)

有時候，你只想在特定條件滿足時才觸發中斷點（例如，在一個迴圈中，只關心 `i == 50` 的情況）。

**設定方法：**
右鍵點擊中斷點 -> 選擇「條件 (Conditions...)」-> 輸入一個回傳布林值的 C# 運算式，例如 `i == 50` 或 `username == "admin"`。

當中斷點被命中時，只有當這個條件為 `true`，執行才會暫停。這對於處理大量資料或迴圈時非常有用。

### c. 追蹤點 (Tracepoints / Logpoints)

如果你不想暫停執行，而只是想在某行被執行時輸出一條日誌訊息，可以使用追蹤點。

**設定方法：**
右鍵點擊中斷點 -> 選擇「動作 (Actions...)」-> 在日誌訊息框中輸入你想輸出的內容。你可以使用 `{}` 來包含 C# 運算式，例如 `變數 user 的值是: {user.Name}`。

這個訊息會被輸出到偵錯主控台的「輸出 (Output)」視窗，而不會中斷應用程式的流程。

## 2. 檢查狀態 (Inspecting State)

當程式在中斷點暫停時，檢查變數和物件的狀態是偵錯的核心。

### a. 資料提示 (DataTips)
將滑鼠懸停在程式碼中的任何變數上，IDE 會彈出一個小視窗，顯示該變數的目前值。你可以展開物件和集合，查看其內部的屬性和元素。

### b. 監看視窗 (Watch Windows)
你可以將特定的變數或運算式拖曳到「監看 (Watch)」視窗中。這樣，無論程式在哪裡暫停，你都可以持續追蹤這些運算式的值。這對於觀察一個變數在多次方法呼叫中的變化特別有用。

### c. 即時運算視窗 (Immediate Window)
這是一個強大的互動式視窗 (REPL)。當程式暫停時，你可以在這裡輸入任何 C# 運算式並立即執行它。你可以：
*   查詢變數的值：`? myVariable`
*   修改變數的值：`myVariable = "new value"`
*   呼叫方法：`? myService.GetUser("test")`
*   建立新物件：`? new MyObject()`

這讓你可以在不修改程式碼、不重新啟動應用程式的情況下，動態地測試和驗證邏輯。

## 3. ASP.NET Core 專屬的偵錯技巧

### a. 開發者例外頁面 (Developer Exception Page)
在**開發環境**中，當發生未處理的例外時，ASP.NET Core 會顯示一個非常詳細的錯誤頁面。這個頁面包含了：
*   **堆疊追蹤 (Stack Trace)**: 顯示了導致錯誤的完整方法呼叫鏈。
*   **查詢字串、Cookies、標頭**: 顯示了觸發錯誤的 HTTP 請求的詳細資訊。
*   **路由資訊**: 顯示了哪個路由模式匹配了這個請求。

這是解決 500 錯誤的第一站。

### b. 請求偵錯中介軟體
有時候你想查看一個**成功**請求的詳細資訊。你可以使用 `app.UseDeveloperExceptionPage()` 之外的中介軟體來幫助你。例如，一些社群提供的中介軟體可以在頁面上顯示 `HttpContext` 的所有細節。

### c. 記錄 (Logging)
ASP.NET Core 內建了強大的記錄框架。在你認為可能出錯的邏輯區塊中，策略性地加入日誌輸出，是追蹤複雜流程的有效方法。

```csharp
_logger.LogInformation("開始處理訂單 {OrderId}", order.Id);

try
{
    // ... 業務邏輯 ...
    _logger.LogDebug("訂單 {OrderId} 的庫存檢查通過", order.Id);
}
catch (Exception ex)
{
    _logger.LogError(ex, "處理訂單 {OrderId} 時發生錯誤", order.Id);
    throw;
}
```
在開發時，將日誌級別設定為 `Debug` 或 `Trace`，可以從「輸出」視窗中獲得大量的執行緒索。

## 4. 前端偵錯

不要忘記，很多問題發生在瀏覽器端。

*   **瀏覽器開發人員工具 (F12)**:
    *   **主控台 (Console)**: 查看 JavaScript 錯誤、`console.log` 的輸出。
    *   **網路 (Network)**: 檢查每一個 HTTP 請求的狀態碼、標頭、內容。查看 AJAX (Fetch/XHR) 請求是否成功，回傳的 JSON 是否符合預期。
    *   **原始碼 (Sources)**: 為 JavaScript 程式碼設定中斷點，進行前端偵錯。

## 結論

有效的偵錯是一種結合了工具使用和邏輯推理的技能。

1.  **從中斷點開始**：這是理解程式碼流程最直接的方式。
2.  **善用條件中斷點和追蹤點**：在處理大量資料和迴圈時，它們能幫你節省大量時間。
3.  **學會檢查狀態**：熟練使用資料提示、監看視窗和即時運算視窗，深入了解程式的內部狀態。
4.  **利用 ASP.NET Core 的內建工具**：開發者例外頁面和日誌框架是你解決問題的得力助手。
5.  **前後端結合**：當問題涉及 API 呼叫或前端互動時，同時使用 IDE 的後端偵錯器和瀏覽器的前端開發人員工具。

養成良好的偵錯習慣，不僅能讓你更快地修復 Bug，更能讓你寫出更可靠、更健壯的程式碼。
